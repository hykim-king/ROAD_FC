<html layout:decorate="~{layout}">
<style layout:fragment="style">
.center-box {
  display: flex;
  justify-content: center;
}

.center-form {
  width: 100%;
  max-width: 600px;
}

.half-width-input {
  width: 100%;
}

.tall-input {
  height: 50px;
}

.btn-block {
  width: auto;
  white-space: nowrap; /* 버튼의 내용을 한 줄로 유지 */
}

</style>
<div layout:fragment="content" class="myMargin container center-box">
    <form id="findUsernameForm" th:object="${request}" class="center-form" onsubmit="event.preventDefault(); findUsername();">
        <div class="mb-3 row align-items-center">
            <label for="idemail" class="col-sm-2 col-form-label">이메일</label>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div class="col-sm-7">
                <input type="email" class="form-control half-width-input tall-input" name="email" id="idemail" required>
            </div>
            <div class="col-sm-3 d-flex justify-content-end">
                <button type="submit" class="btn btn-primary btn-full-width" onclick="findUsername()">아이디 찾기</button>
            </div>
        </div>
    </form>
    
    <div class="modal fade" id="findUsernameModal" tabindex="-1"
        aria-labelledby="findUsernameModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">아이디 찾기</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="usernameResult"></div>
                </div>
                <button type="button" class="btn btn-secondary btn-sm"
                        data-bs-dismiss="modal" th:href="@{/member/login}">닫기</button>
            </div>
        </div>
    </div>
</div>
<script layout:fragment="script">
    function findUsername() {
        const email = document.getElementById('idemail').value;
        const csrfToken = document.querySelector('input[name="_csrf"]').value;

        $.ajax({
            url : '/member/findUsername',
            type : 'POST',
            data : {
                email : email,
                _csrf : csrfToken
            },
            success : function(response) {
                if (response.error) {
                    $('#usernameResult').html('<div class="alert alert-danger">' + response.error + '</div>');
                } else {
                    $('#usernameResult').html('<div class="alert alert-success">고객님 아이디는 ' + response.username + ' 입니다.</div>');
                }
                $('#findUsernameModal').modal('show'); // 모달 수동 표시
            },
            error : function() {
                $('#usernameResult').html('<div class="alert alert-danger">아이디를 찾을 수 없습니다.</div>');
                $('#findUsernameModal').modal('show'); // 모달 수동 표시
            }
        });
    }
</script>
</html>
