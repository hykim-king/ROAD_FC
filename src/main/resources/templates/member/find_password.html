<html layout:decorate="~{layout}">
<div layout:fragment="content" class="myMargin container myContainer margin3">
	<h5 class="border-bottom py-3 ps-2 mb-4">비밀번호 찾기</h5>
	<form id="findPasswordForm" th:object="${request}" class="center-form"
		onsubmit="event.preventDefault(); findPassword();">
		<div class="center-div">
			<label for="passemail" class="col-sm-2 col-form-label">이메일</label> <input
				type="hidden" th:name="${_csrf.parameterName}"
				th:value="${_csrf.token}" />
			<div class="">
				<input type="email" class="form-control half-width-input tall-input"
					name="email" id="passemail">
			</div>
			<div class="d-flex justify-content-end">
				<button type="button" class="btn btn-okay btn-full-width"
					onclick="findPassword()">비밀번호 찾기</button>
			</div>
		</div>
	</form>

	<!-- 비밀번호 찾기 모달 -->
	<div class="modal fade" id="findPasswordModal" tabindex="-1"
		aria-labelledby="findPasswordModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="exampleModalLabel">비밀번호 찾기</h1>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div id="passwordResult"></div>
				</div>
				<button type="button" class="btn btn-secondary btn-sm"
					data-bs-dismiss="modal" th:href="@{/member/login}">닫기</button>
			</div>
		</div>
	</div>
	<!-- 로딩 모달 -->
	<div class="modal fade" id="loadingModal" tabindex="-1"
		aria-labelledby="loadingModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="loadingModalLabel">잠시만 기다려주세요</h1>
				</div>
				<div class="modal-body">
					<p>이메일을 전송 중입니다...</p>
				</div>
			</div>
		</div>
	</div>
</div>

<script layout:fragment="script">
	function findPassword() {
		const email = document.getElementById('passemail').value;
		const csrfToken = document.querySelector('input[name="_csrf"]').value;

		// 이메일 주소가 비어 있거나 유효하지 않으면 결과 모달 표시
		if (!email || !validateEmail(email)) {
			$('#passwordResult').html(
					'<div class="alert alert-danger">유효한 이메일 주소를 입력하세요.</div>');
			$('#findPasswordModal').modal('show');
			return;
		}

		$
				.ajax({
					url : '/member/findPassword',
					type : 'POST',
					data : {
						email : email,
						_csrf : csrfToken
					},
					beforeSend : function() {
						$('#loadingModal').modal('show'); // 로딩 모달 표시
					},
					success : function(response) {
						$('#loadingModal').modal('hide'); // 로딩 모달 숨기기
						if (response.error) {
							$('#passwordResult').html(
									'<div class="alert alert-danger">'
											+ response.error + '</div>');
						} else {
							$('#passwordResult').html(
									'<div class="alert alert-success">'
											+ response.message + '</div>');
						}
						$('#findPasswordModal').modal('show'); // 결과 모달 표시
					},
					error : function() {
						$('#loadingModal').modal('hide'); // 로딩 모달 숨기기
						$('#passwordResult')
								.html(
										'<div class="alert alert-danger">비밀번호를 찾을 수 없습니다.</div>');
						$('#findPasswordModal').modal('show'); // 결과 모달 표시
					},
					statusCode : {
						404 : function() {
							$('#loadingModal').modal('hide'); // 로딩 모달 숨기기
							$('#passwordResult')
									.html(
											'<div class="alert alert-danger">존재하지 않는 이메일 주소입니다.</div>');
							$('#findPasswordModal').modal('show'); // 결과 모달 표시
						}
					}
				});
	}

	// 이메일 유효성 검사를 위한 함수
	function validateEmail(email) {
		const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
		return re.test(email);
	}
</script>

</html>
