<html layout:decorate="~{layout}">
<div layout:fragment="content" class="container myPage my-info">
	<div class="myPage-container">
		<h3 class="my-title text-center mt-3 mx-5 pb-3">나의 정보</h3>
		<div class="sign-form">
			<div class="form-group">
				<input type="hidden" th:name="${_csrf.parameterName}"
					th:value="${_csrf.token}" /> <label th:for="username">아이디</label>
				<input type="text" th:value="${member.username}"
					class="form-control" style="width: 100%;" readonly>
			</div>
			<div class="form-group">
				<label th:for="userDisName">이름</label> <input type="text"
					th:value="${member.userDisName}" class="form-control"
					style="width: 100%;" readonly>
			</div>
			<div class="form-group">
				<label th:for="email">이메일</label> <input type="text"
					th:value="${member.email}" class="form-control"
					style="width: 100%;" readonly>
			</div>
			<div class="form-group">
				<label th:for="userRegDt">가입일</label> <input type="text"
					th:value="${#temporals.format(member.userRegDt,'yyyy-MM-dd HH:mm')}"
					class="form-control" style="width: 100%;" readonly>
			</div>
			<div class="text-end" th:if="${member.username != 'manager'}">
				<a href="#" class="text-decoration-none text-dark mx-2"
					id="btn_withdraw">회원 탈퇴</a>
			</div>
		</div>
		<!-- 유저 아이디를 숨긴 필드로 추가 -->
		<input type="hidden" id="loggedInUserId" th:value="${member.username}">
	</div>
</div>
<script layout:fragment="script">
const btn_withdraw = document.getElementById("btn_withdraw");
const csrfToken = document.querySelector('input[name="_csrf"]').value;
btn_withdraw.addEventListener('click', function() {
    if (confirm('회원 탈퇴하시겠습니까?') === false) return;

    // 숨긴 필드에서 유저 아이디 값을 가져옴
    const loggedInUserId = document.getElementById("loggedInUserId").value;

    $.ajax({
        type: "POST",
        url: "/member/withdraw",
        async: true,
        dataType: "html",
        data: {
            "username": loggedInUserId,
            "_csrf": csrfToken // CSRF 토큰 포함
        },
        success: function(response) {
            console.log("회원 탈퇴 성공 response:" + response);
            // 로그아웃 요청 추가
            $.ajax({
                type: "POST",
                url: "/member/logout", // Spring Security 로그아웃 URL 확인
                async: true,
                data: {
                    "_csrf": csrfToken // CSRF 토큰 포함
                },
                complete: function() {
                    window.location.href = "/member/login"; // 로그아웃 성공 여부와 상관없이 리디렉션
                }
            });
        },
        error: function(response) {
            console.log("회원 탈퇴 중 오류 response:" + response);
            alert("회원 탈퇴 중 오류가 발생했습니다. 다시 시도해 주세요.");
        }
    });
});

// CSS 추가
const style = document.createElement('style');
style.innerHTML = `
    .form-control[readonly] {
        background-color: #fff; /* 흰색 배경 */
        color: #495057; /* 일반 텍스트 색상 */
        opacity: 1; /* 투명도 */
    }
    .sidebar-container {
        margin-left: -10px; /* 사이드바 왼쪽으로 이동 */
    }
`;
document.head.appendChild(style);
</script>
</html>