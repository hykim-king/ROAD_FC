<html layout:decorate="~{layout}">
<div layout:fragment="content" class="container myChart">
	<div class="title-content">
		<h5 class="main-title">연도별 교통사고 추이</h5>
		<p class="description">교통사고 통계를 한눈에 볼 수 있습니다.</p>
	</div>
	<!-- 데이터 테이블 -->
	<div class="mt-4">
		<table class="table table-hover">
			<thead class="table-light text-nowrap">
				<tr class="text-center">
					<th>#</th>
					<th>연도</th>
					<th>사고(건)</th>
					<th>사고건수 증가율(%)</th>
					<th>사망자(명)</th>
					<th>사망자수 증가율(%)</th>
					<th>치사율(%)</th>
					<th>부상자(명)</th>
					<th>부상자수 증가율(%)</th>
				</tr>
			</thead>
			<tbody>
				<tr th:each="accident, iterStat : ${accidents}">
					<td th:text="${paging.number * paging.size + iterStat.count}"></td>
					<td th:text="${accident.tdYear}"></td>
					<td th:text="${accident.tdAccident}"></td>
					<td
						th:text="${#numbers.formatDecimal(accident.yearAccidentRate.taAccidentRate != null ? accident.yearAccidentRate.taAccidentRate : 0, 1, 1) + '%'}"></td>
					<td th:text="${accident.tdDeathCnt}"></td>
					<td
						th:text="${#numbers.formatDecimal(accident.yearAccidentRate.taDeathRate != null ? accident.yearAccidentRate.taDeathRate : 0, 1, 1) + '%'}"></td>
					<td
						th:text="${#numbers.formatDecimal(accident.yearAccidentRate.taFatalRate != null ? accident.yearAccidentRate.taFatalRate : 0, 1, 1) + '%'}"></td>
					<td th:text="${accident.tdInjuryCnt}"></td>
					<td
						th:text="${#numbers.formatDecimal(accident.yearAccidentRate.taInjuryRate != null ? accident.yearAccidentRate.taInjuryRate : 0, 1, 1) + '%'}"></td>
				</tr>
				<tr th:if="${#lists.isEmpty(accidents)}">
					<td colspan="9" class="text-center">데이터가 없습니다.</td>
				</tr>
			</tbody>
		</table>
	</div>
	<!-- 데이터 테이블 끝 -->

	<div class="sub-content" style="text-align: right">
		<h6>"치사율" : 사상자 100명당 사망자수의 비율</h6>
	</div>

	<div class="chart-container mt-5">
		<canvas id="trafficChart" style="width: 100%; height: 400px;"></canvas>
	</div>
</div>
</div>
<!-- 스크립트 -->
<script layout:fragment="script" th:inline="javascript">
$(document).ready(function () {
    let chart;
    let rawData = [
        {tdYear: 2014,taAccidentRate:3.8,taDeathRate:-6.5,taFatalRate:2.1,taInjuryRate:2.7},
        {tdYear: 2015,taAccidentRate:3.8,taDeathRate:-3.0,taFatalRate:2.0,taInjuryRate:3.8},
        {tdYear: 2016,taAccidentRate:-4.8,taDeathRate:-7.1,taFatalRate:1.9,taInjuryRate:-5.3},
        {tdYear: 2017,taAccidentRate:-2.1,taDeathRate:-2.5,taFatalRate:1.9,taInjuryRate:-2.7},
        {tdYear: 2018,taAccidentRate:0.4,taDeathRate:-9.7,taFatalRate:1.7,taInjuryRate:0.1},
        {tdYear: 2019,taAccidentRate:5.7,taDeathRate:-11.4,taFatalRate:4.1,taInjuryRate:5.8},
        {tdYear: 2020,taAccidentRate:-8.7,taDeathRate:-8.0,taFatalRate:1.5,taInjuryRate:-10.4},
        {tdYear: 2021,taAccidentRate:-3.1,taDeathRate:-5.4,taFatalRate:1.4,taInjuryRate:-4.8},
        {tdYear: 2022,taAccidentRate:-3.1,taDeathRate:-6.2,taFatalRate:1.4,taInjuryRate:-3.4},
        {tdYear: 2023,taAccidentRate:0.7,taDeathRate:-6.7,taFatalRate:1.3,taInjuryRate:0.7}
      ];

    console.log("📊 초기 데이터 로드:", rawData);
    
    createChart(rawData);

    $("form").on("submit", function(event) {
      event.preventDefault();
      fetchDataAndUpdateChart();
    });

    async function fetchDataAndUpdateChart() {
      let year = $("#year").val();
      let url = `/DataChart/datalist1/json?year=${year}`;

      try {
        let response = await fetch(url);
        if (!response.ok) throw new Error("Network response was not ok");
        let data = await response.json();

        console.log("📊 API 응답 데이터:", data); // 🔥 API에서 받은 원본 데이터
        console.log("📊 필터링된 데이터 구조 확인:", Object.keys(data[0])); // 🔥 필드 목록 확인

        if (!Array.isArray(data)) throw new Error("Invalid data format");

        updateChart(data, year ? "bar" : "line", !year);
        updateTable(data);
      } catch (error) {
        console.error("❌ 데이터 불러오기 오류:", error);
      }
    }

    function parseJSONData(rawData) {
      try {
        return JSON.parse(rawData);
      } catch (e) {
        console.error("JSON parsing error:", e);
        return [];
      }
    }

    function createChart(data) {
      if (chart) chart.destroy();
      let ctx = document.getElementById('trafficChart').getContext("2d");

      chart = new Chart(ctx, {
          type: "line",
          data: {
              labels: data.map(item => item.tdYear), // ✅ rawData의 키에 맞게 수정
              datasets: [
                  {
                      label: "종합 사고 증가율",
                      data: data.map(item => item.taAccidentRate),
                      backgroundColor: "rgba(75, 192, 192, 0.5)",
                      borderColor: "rgba(75, 192, 192, 1)",
                      borderWidth: 1,
                      fill: false
                  },
                  {
                      label: "사망사고 발생 증가율",
                      data: data.map(item => item.taDeathRate), 
                      backgroundColor: "rgba(255, 99, 132, 0.5)",
                      borderColor: "rgba(255, 99, 132, 1)",
                      borderWidth: 1,
                      fill: false
                  },
                  {
                      label: "부상 사고 발생 증가율",
                      data: data.map(item => item.taInjuryRate),
                      backgroundColor: "rgba(255, 206, 86, 0.5)",
                      borderColor: "rgba(255, 206, 86, 1)",
                      borderWidth: 1,
                      fill: false
                  },
                  {
                      label: "치사율",
                      data: data.map(item => item.taFatalRate),
                      backgroundColor: "rgba(153, 102, 255, 0.5)",
                      borderColor: "rgba(153, 102, 255, 1)",
                      borderWidth: 1,
                      fill: false
                  }
              ]
          },
          options: {
              responsive: true,
              scales: {
                y: {
                  min: -15,
                  max: 15,
                  title: {
                    display: true,
                    text: "증가율 (%)",
                  },
                },
                y1: {
                  position: "right",
                  min: 0,
                  max: 2, // ✅ 치사율의 범위 설정
                  grid: {
                    drawOnChartArea: false, // ✅ 주 Y축과 겹치지 않게
                  },
                  title: {
                    display: true,
                    text: "치사율 (%)",
                  }
                }
              }
          }
      });
    }
});
</script>
</html>