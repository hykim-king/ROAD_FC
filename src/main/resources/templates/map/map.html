<html layout:decorate="~{layout}">
	<!-- <div class="container-fluid position-relative">
		<div class="position-absolute top-0 start-50 translate-middle-x bg-white shadow p-3 rounded" style="width: 60%; z-index: 1000;">
			<marquee behavior="scroll" direction="left" scrollamount="5" class="fw-bold text-danger">
	      ğŸš¨ [ê³µì§€] í˜„ì¬ ì„œìš¸ ê°•ë‚¨êµ¬ ì¼ëŒ€ ë„ë¡œ ê³µì‚¬ë¡œ ì¸í•´ ì •ì²´ê°€ ì‹¬í•©ë‹ˆë‹¤. ìš°íšŒ ë„ë¡œë¥¼ ì´ìš©í•´ì£¼ì„¸ìš”! ğŸš¨
	    </marquee>
		</div>
	</div> -->
  <div layout:fragment="mapContent" 
       class="container-fluid flex-grow-1 position-relative" 
       id="map" 
       style="height: calc(100vh - 80px); margin-top: 80px; margin-left: 400px;">
  	<div class="position-absolute start-50 translate-middle-x bg-white border border-4 border-warning-subtle shadow p-3 rounded" style="top: 3%; z-index: 1000;">
			<marquee behavior="scroll" direction="left" scrollamount="5" class="fs-5 fw-bold text-danger">
	      ğŸš¨ [ê³µì§€] í˜„ì¬ ì„œìš¸ ê°•ë‚¨êµ¬ ì¼ëŒ€ ë„ë¡œ ê³µì‚¬ë¡œ ì¸í•´ ì •ì²´ê°€ ì‹¬í•©ë‹ˆë‹¤. ìš°íšŒ ë„ë¡œë¥¼ ì´ìš©í•´ì£¼ì„¸ìš”! ğŸš¨
	    </marquee>
		</div>
		<div class="row text-center position-absolute end-0 translate-middle-x bg-white border border-2 p-3 shadow rounded" style="top: 5%; z-index: 1000;">
			<div class="col-6">
				<a href="#">ì „êµ­</a>
			</div>
			<div class="col-6">
				<a href="#">ìˆ˜ë„ê¶Œ</a>
			</div>
			<div class="col-6">
				<a href="#">ê°•ì›ê¶Œ</a>
			</div>
			<div class="col-6">
				<a href="#">ì¶©ì²­ê¶Œ</a>
			</div>
			<div class="col-6">
				<a href="#">ì „ë¼ê¶Œ</a>
			</div>
			<div class="col-6">
				<a href="#">ê²½ìƒê¶Œ</a>
			</div>
		</div>
  </div>

  <!-- scriptíƒœê·¸ ì•ˆì—ìˆëŠ” thymeleafë¬¸ í•´ì„í•˜ë ¤ê³  th:inline ì‚¬ìš© -->
  <script layout:fragment="script" th:inline="javascript">
  var mapContainer = document.getElementById('map');
  
  var mapOption = {
      center: new kakao.maps.LatLng(37.566826, 126.9786567), 
      level: 10
  };
  
  var map = new kakao.maps.Map(mapContainer, mapOption);
  map.setMinLevel(6);
  map.setMaxLevel(13);
  	   
  /* 
  ì‚¬ê³  ë§ˆì»¤ ì´ë¯¸ì§€
  var accidentImageSrc = "https://t1.daumcdn.net/localimg/localimages/07/2018/pc/trafficinfo/accident.png" 
  ê³µì‚¬ ë§ˆì»¤ ì´ë¯¸ì§€
  var constructionImageSrc = "https://t1.daumcdn.net/localimg/localimages/07/2018/pc/trafficinfo/construction.png" 
  */
  
  var cctvImageSrc = "https://t1.daumcdn.net/localimg/localimages/07/2023/pc/marker_cctv.png",
  	   imageSize = new kakao.maps.Size(22,23);
  
  var markerImage = new kakao.maps.MarkerImage(cctvImageSrc, imageSize);
  
  /* ë‚´ì¸„ëŸ´ í…œí”Œë¦¿ (ì£¼ì„ ì§€ìš°ë©´ X)*/
  var cctvInfo = /*[[${cctvInfo}]]*/ [];
  
  var markers = [];

  cctvInfo.forEach(function(cctv) {
      var marker = new kakao.maps.Marker({
          position: new kakao.maps.LatLng(cctv.cctv_lat, cctv.cctv_lon),
          image: markerImage
      });
      markers.push(marker);
  });

  /*
  var clusterer = new kakao.maps.MarkerClusterer({
      map: map,
      markers: markers,
      gridSize: 50, // Number : í´ëŸ¬ìŠ¤í„°ì˜ ê²©ì í¬ê¸°. í™”ë©´ í”½ì…€ ë‹¨ìœ„ì´ë©° í•´ë‹¹ ê²©ì ì˜ì—­ ì•ˆì— ë§ˆì»¤ê°€ í¬í•¨ë˜ë©´ í´ëŸ¬ìŠ¤í„°ì— í¬í•¨ì‹œí‚¨ë‹¤ 
      averageCenter: true, // Boolean : ë§ˆì»¤ë“¤ì˜ ì¢Œí‘œ í‰ê· ì„ í´ëŸ¬ìŠ¤í„° ì¢Œí‘œ ì„¤ì • ì—¬ë¶€
      minLevel: 10, // Number : í´ëŸ¬ìŠ¤í„°ë§ í•  ì§€ë„ì˜ ìµœì†Œ ë ˆë²¨ ê°’
      disableClickZoom: false // Boolean : í´ëŸ¬ìŠ¤í„° í´ë¦­ ì‹œ ì§€ë„ í™•ëŒ€ ì—¬ë¶€. trueë¡œ ì„¤ì •í•˜ë©´ í´ëŸ¬ìŠ¤í„° í´ë¦­ ì‹œ í™•ëŒ€ ë˜ì§€ ì•ŠëŠ”ë‹¤
  });
  */
  
  
  // ë§ˆì»¤ ê·¸ë£¹í•‘ í´ë˜ìŠ¤
  class MarkerGroup{
	   constructor(markers){
		   this.markers = markers;
		   this.center = this.calculateCenter();
		   this.representativeMarker = null;
	   }
	   
	   calculateCenter(){
		   //ë§ˆì»¤ ê°ì²´ê°€ ìƒì„±ë˜ì–´ìˆì§€ ì•Šìœ¼ë©´ return
		   if(this.markers.length == 0) return null;
		   
		   // ìœ„ë„ í•©, ê²½ë„ í•© ë³€ìˆ˜ë“¤ì„ ì„ ì–¸
		   let sumOfLats = 0;
		   let sumOfLongs = 0;
		   
		   // ë§ˆì»¤ ì¼ì¼ì´ ìˆœíšŒí•˜ì—¬ ê° ìœ„ë„ì™€ ê²½ë„ì˜ í•©ì„ ê³„ì‚°    		   
		   this.markers.forEach(marker =>{    			  
			   sumOfLats += marker.cctv_lat;
			   sumOfLongs += marker.cctv_lon;    			   
		   });
		   
		   // ìœ„ë„ì˜ í•©/ë§ˆì»¤ ê°¯ìˆ˜, ê²½ë„ í•©/ë§ˆì»¤ ê°¯ìˆ˜ ë¥¼ ê³„ì‚°í•˜ì—¬,
		   // í‰ê·  ìœ„ë„ì™€ í‰ê·  ê²½ë„ë¥¼ return
		   return {
			   lat : sumOfLats / this.markers.length, //ìœ„ë„ í‰ê· ê°’
			   lon : sumOfLongs / this.markers.length //ê²½ë„ í‰ê· ê°’
		   }    
	   }
  }
  
  class MarkerManager {
	   constructor(map,cctvInfo, markerImage){
		   this.map = map; //ì§€ë„
		   this.cctvInfo = cctvInfo; //cctv ì •ë³´
		   this.markerImage = markerImage; // ë§ˆì»¤ì´ë¯¸ì§€
		   this.groups = []; // ê·¸ë£¹
		   this.visibleMarkers = []; // ì‹¤ì œ ë§µì—ì„œ ë³´ì´ëŠ” ë§ˆì»¤
		   //this.GROUPING_DISTANCE = 0.5; //ê·¸ë£¹í™” ê±°ë¦¬ ê¸°ì¤€ (500ë¯¸í„°)
		   
		   // ì¤Œ ë ˆë²¨ ì„¤ì • (MAX,MIN)
		   this.MAP_LEVELS = {
			   MAX_LEVEL: 13, // ê°€ì¥ ZOOM OUTëœ ìƒíƒœ
			   MIN_LEVEL: 6   // ê°€ì¥ ZOOM INëœ ìƒíƒœ    			   
		   };
		   
		   //this.setGroups();
		   this.bindEvents();
	   }
	   
	   //ë§ˆì»¤ë“¤ì„ ê·¸ë£¹í™”í•˜ëŠ” í•¨ìˆ˜
	   //setGroupì—ì„œ í•´ì•¼í• ë“¯
	   setGroups(){
		   this.groups =[];
		   console.log("setGroups()")
		   let ungroupedMarkers = [...this.cctvInfo]; // ... (ìŠ¤í”„ë ˆë“œ ì—°ì‚°ì)ë¥¼ ì‚¬ìš©í•˜ì—¬ cctv ì •ë³´ ë°°ì—´ ë³µì œ
		   
		   const currentLevel = this.map.getLevel(); // í˜„ì¬ ì¤Œ ë ˆë²¨
		   this.setGroupingDistance(currentLevel);
		   
		   while(ungroupedMarkers.length > 0){
			   let currentMarker = ungroupedMarkers[0];  // ê·¸ë£¹í™”ë˜ì§€ ì•Šì€ ë§ˆì»¤ ì¤‘ ì²« ë²ˆì§¸ ë§ˆì»¤ë¥¼ í˜„ì¬ ë§ˆì»¤ë¡œ ì§€ì • 
			   let group = [currentMarker];              // ìƒˆ ê·¸ë£¹ ì„ ì–¸
			   
			   //ê·¸ë£¹í™” ë˜ì–´ìˆì§€ ì•Šì€ ë§ˆì»¤ë“¤ì„ ìˆœíšŒí•´ì„œ í˜„ ë§ˆì»¤ì™€ì˜ ê±°ë¦¬ ê³„ì‚°
			   for(let i = 1; i< ungroupedMarkers.length; i++){
				   let distance = this.calcDistance(ungroupedMarkers[i].cctv_lat
						   							, ungroupedMarkers[i].cctv_lon
						   							, currentMarker.cctv_lat
						   							, currentMarker.cctv_lon);
				       				   
				   // ê¸°ì¤€ìœ¼ë¡œ ì¡ì•˜ë˜ ê±°ë¦¬ ì´ë‚´ì¼ ê²½ìš° ê·¸ë£¹(ë°°ì—´)ì— ì¶”ê°€ (ê·¸ë£¹í™”)
   			   if(distance <= this.GROUPING_DISTANCE){
   				   group.push(ungroupedMarkers[i]);
   			   }    
			   }
			   
			   ungroupedMarkers = ungroupedMarkers.filter(marker =>
		   				!group.includes(marker)
		   		   );		  
			   
			   this.groups.push(new MarkerGroup(group));
		   }        		       		 
	   }
	   
	   // ì ê³¼ ì  ê±°ë¦¬ ê³„ì‚° ê³µì‹: ((x2-x1)^2 + (y2-y1)^2)^1/2
	   calcDistance(lat1, lon1, lat2, lon2 ){
		   let distance = Math.sqrt(
					Math.pow(lat2 - lat1, 2) + Math.pow(lon2 - lon1, 2)    
		   			);
		   
		   return distance;
	   }
	   
	   setGroupingDistance(currentLevel){
		   const distanceByLevel = {  
				   13 : 0.5,		// 50km
				   12 : 0.4,		// 40km
				   11 : 0.2,		// 20km
				   10 : 0.1,		// 10km	
				   9  : 0.05,		// 5km
				   8  : 0.02,		// 1km
				   7  : 0.0001,     // 0.01km (10ë¯¸í„°)  
				   6  : 0.0001		// 0.01km (10ë¯¸í„°) 
		   };
		   
		   this.GROUPING_DISTANCE = distanceByLevel[currentLevel];
	   }
	   
	   
	   // ì§€ë„ì— í‘œì‹œë  ë§ˆì»¤ ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
	   updateMarkers(){
		   this.setGroups();
		   this.clearMarkers(); // ëª¨ë“  ë§ˆì»¤ ì§€ë„ì—ì„œ ì œê±°
		       		   
		   const currentLevel = this.map.getLevel(); // í˜„ì¬ ì¤Œ ë ˆë²¨ 
		   const bounds = this.map.getBounds();      // í˜„ì¬ ì§€ë„ ì˜ì—­    		   
		   
		   console.log('currentLevel: ' + currentLevel);
		   console.log('GroupingDistance: ' + this.GROUPING_DISTANCE);
		   
		   this.groups.forEach(group => {
			   if (!group.center) return;
			  
			  // ê·¸ë£¹ ì¤‘ì‹¬ì ì˜ ìœ„ì¹˜ ê°ì²´ ìƒì„±
			  const centerPosition = new kakao.maps.LatLng(group.center.lat, group.center.lon);
			  
			  // í˜„ì¬ ì§€ë„ ì˜ì—­ ë°–ì˜ ê·¸ë£¹ì¼ ê²½ìš° return
			  if (!bounds.contain(centerPosition)) return;
			  
			  // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ ë§ˆì»¤ í‘œì‹œ
			  // ZOOM OUT
			 if (currentLevel == this.MAP_LEVELS.MAX_LEVEL) {
				  this.GROUPING_DISTANCE = 1;
				  this.addMarker(centerPosition, `${group.markers.length}ê°œì˜ CCTV`);
				  console.log('ë§ˆì»¤ ê°¯ìˆ˜: ${group.markers.length}')
				  
			 } else if (currentLevel == this.MAP_LEVELS.MIN_LEVEL) {
		            // ZOOM IN ìƒíƒœ (ë ˆë²¨ ê°’ì´ ì‘ìŒ = ë” í™•ëŒ€ëœ ìƒíƒœ)
		            // ìµœëŒ€í•œ í™•ëŒ€ëì„ ë•ŒëŠ” ëª¨ë“  ê°œë³„ ë§ˆì»¤ í‘œì‹œ
		            group.markers.forEach(marker => {
		                const markerPosition = new kakao.maps.LatLng(marker.cctv_lat, marker.cctv_lon);
		                this.addMarker(markerPosition, marker.cctv_name);
		            });
		            
		      } else{
		    	  this.addMarker(centerPosition, `${group.markers.length}ê°œì˜ CCTV`);
		    	  console.log('ë§ˆì»¤ ê°¯ìˆ˜: ${group.markers.length}')
		      }	  
		   });
	   }
	   
	   // ë§ˆì»¤ ìƒì„± í•¨ìˆ˜
	   addMarker(position, title) {
	        const marker = new kakao.maps.Marker({
	            position: position,
	            image: this.markerImage
	        });
	        
	        // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
	        kakao.maps.event.addListener(marker, 'click', () => {
	            this.showMarkerInfo(marker, title);
	        });
	        
	        marker.setMap(this.map);                 // ì§€ë„ì— ë§ˆì»¤ í‘œì‹œ
	        this.visibleMarkers.push(marker);        // í‘œì‹œëœ ë§ˆì»¤ ëª©ë¡ì— ì¶”ê°€
	    }
	   
	    // ëª¨ë“  ë§ˆì»¤ ì œê±° í•¨ìˆ˜
		clearMarkers(){
			this.visibleMarkers.forEach(marker => marker.setMap(null));
			this.visibleMarkers = []; // ë³´ì´ëŠ” ë§ˆì»¤ empty arrayë¡œ ë§Œë“¤ê¸°
		}
	    
	    // ë§ˆì»¤ info display í•¨ìˆ˜
	    showMarkerInfo(marker,title){
	    	const infoWindow = new kakao.maps.InfoWindow({
	    		content: `<div style= "padding:5px;">${title}</div>`
	    	});
	    	infoWindow.open(this.map,marker); //ì •ë³´ì°½ ë„ìš°ê¸°
	    }
	    
	    // ì§€ë„ zoom level ë³€ê²½, ì´ë™ ì‹œ ë§ˆì»¤ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
	    bindEvents(){
	    	kakao.maps.event.addListener(this.map, 'zoom_changed', () => {
	    		this.updateMarkers();    	    		
	    	});
	    	
	    	kakao.maps.event.addListener(this.map, 'idle', () => {
	    		this.updateMarkers();    	    		
	    	});
	    }
  }        
  
  const markerManager = new MarkerManager(map, cctvInfo, markerImage);
  </script>
</html>
